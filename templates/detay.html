{% extends 'base.html' %}

{% block content %}

<style>
    /* Haber içeriğindeki resimler taşmasın */
    .haber-icerik { width: 100%; overflow: hidden; }
    .haber-icerik img { max-width: 100% !important; height: auto !important; display: block !important; margin: 15px auto !important; border-radius: 8px; }
    /* CKEditor'den gelen iframe'leri de responsive yap */
    .haber-icerik iframe, .haber-icerik video, .haber-icerik embed { max-width: 100% !important; width: 100% !important; aspect-ratio: 16 / 9; height: auto !important; }
</style>

<div class="container my-5">
    
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'anasayfa' %}" class="text-decoration-none text-muted">Anasayfa</a></li>
                    <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-muted">{{ haber.kategori.isim }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ haber.baslik|truncatechars:30 }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="bg-white p-4 shadow-sm border-top border-5 border-success mb-5">
                <h1 class="mb-3 fw-bold display-6" style="color: var(--ahsap-koyu); font-family: 'Playfair Display', serif;">{{ haber.baslik }}</h1>

                <div class="mb-4 text-muted small d-flex align-items-center flex-wrap">
                    <span class="badge bg-success me-2">{{ haber.kategori.isim }}</span>
                    {% if haber.ilce %}
                        <span class="badge bg-secondary me-2">{{ haber.ilce.isim }}</span>
                    {% endif %}
                    <span class="me-3"><i class="far fa-clock me-1"></i> {{ haber.yayin_tarihi|date:"d F Y, H:i" }}</span>
                    <span><i class="fas fa-user-edit me-1"></i> {{ haber.yazar.ad_soyad|default:"Sami Özçelik" }}</span>
                </div>

                {% if haber.resim %}
                    <img src="{{ haber.resim.url }}" class="img-fluid w-100 rounded mb-4" alt="{{ haber.baslik }}">
                {% endif %}

                <div class="haber-icerik fs-5 lh-lg text-dark">{{ haber.icerik|safe }}</div>

                {% if haber.embed_video_url %}
                <div class="mt-4 mb-4">
                    <h5 class="fw-bold mb-2"><i class="fab fa-youtube text-danger me-2"></i>Haber Videosu</h5>
                    <div class="ratio ratio-16x9 shadow-sm rounded overflow-hidden border border-secondary">
                        <iframe src="{{ haber.embed_video_url }}" title="Haber Videosu" allowfullscreen></iframe>
                    </div>
                </div>
                {% endif %}
                {% if haber.yazar %}
                <div class="d-flex align-items-center p-3 rounded mt-5 mb-4 shadow-sm" style="background-color: #f8f9fa; border-left: 4px solid var(--ahsap-koyu);">
                    {% if haber.yazar.resim %}
                    <div class="flex-shrink-0">
                        <img src="{{ haber.yazar.resim.url }}" alt="{{ haber.yazar.ad_soyad }}" 
                             class="rounded-circle border border-white shadow-sm" 
                             style="width: 70px; height: 70px; object-fit: cover;">
                    </div>
                    {% else %}
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center fw-bold" 
                             style="width: 70px; height: 70px; font-size: 1.5rem;">
                            {{ haber.yazar.ad_soyad|slice:":1" }}
                        </div>
                    </div>
                    {% endif %}
                    <div class="flex-grow-1 ms-3">
                        <small class="text-muted text-uppercase fw-bold d-block mb-1" style="font-size: 0.65rem; letter-spacing: 1px;">
                            HABERİN YAZARI
                        </small>
                        <h6 class="mb-0 fw-bold text-dark fs-5">
                            {{ haber.yazar.ad_soyad }}
                            {% if haber.yazar.basyazar_mi %}
                                <span class="badge bg-dark text-white ms-2 align-middle" style="font-size: 0.6rem;">BAŞYAZAR</span>
                            {% endif %}
                        </h6>
                    </div>
                </div>
                {% endif %}

                <div class="my-5 text-center">
                    <div class="d-inline-block bg-light border dashed-border p-3" style="width: 100%; max-width: 728px; height: 90px; display: flex; align-items: center; justify-content: center;">
                        <span class="text-muted fw-bold">YATAY REKLAM ALANI (728x90)</span>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-light rounded border">
                    <h6 class="fw-bold mb-3 text-muted">BU HABERİ PAYLAŞ</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="https://api.whatsapp.com/send?text={{ request.build_absolute_uri }}" target="_blank" class="btn btn-success btn-sm"><i class="fab fa-whatsapp me-1"></i> WhatsApp</a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="btn btn-primary btn-sm"><i class="fab fa-facebook-f me-1"></i> Facebook</a>
                        <a href="https://twitter.com/intent/tweet?text={{ haber.baslik }}&url={{ request.build_absolute_uri }}" target="_blank" class="btn btn-dark btn-sm"><i class="fab fa-x-twitter me-1"></i> X</a>
                        <button onclick="copyLink()" class="btn btn-secondary btn-sm"><i class="fas fa-link me-1"></i> Link Kopyala</button>
                    </div>
                </div>
            </div>

            <div class="mb-5" id="yorumlar">
                <h4 class="border-bottom pb-2 mb-4 fw-bold" style="color: var(--ahsap-koyu);">Yorumlar ({{ yorumlar.count }})</h4>

                <div class="yorum-listesi mb-5">
                    {% for yorum in yorumlar %}
                    <div class="card mb-3 bg-light border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-bold text-dark mb-0">
                                    {{ yorum.isim }}
                                    {% if yorum.destekci_tipi == 'gonul' %}
                                        <span class="badge bg-success ms-2" style="font-size: 0.7em;"><i class="fas fa-heart me-1"></i> Gönül Dostu</span>
                                    {% elif yorum.destekci_tipi == 'sponsor' %}
                                        <span class="badge bg-warning text-dark ms-2" style="font-size: 0.7em;"><i class="fas fa-crown me-1"></i> SPONSOR</span>
                                    {% elif yorum.destekci_tipi == 'okur' %}
                                        <span class="badge bg-primary ms-2" style="font-size: 0.7em;">Okur Desteği</span>
                                    {% endif %}
                                </h6>
                                <small class="text-muted">{{ yorum.olusturulma_tarihi|date:"d M Y H:i" }}</small>
                            </div>
                            <p class="mb-0 text-secondary">{{ yorum.govde }}</p>
                        </div>
                    </div>
                    {% empty %}
                        <div class="alert alert-light border text-center">Henüz yorum yapılmamış. İlk yorumu sen yap!</div>
                    {% endfor %}
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold py-3"><i class="fas fa-pen me-2"></i>Bir Yorum Yaz</div>
                    <div class="card-body p-4">
                        <form method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label text-muted small">Adınız Soyadınız</label>{{ yorum_form.isim }}</div>
                                <div class="col-md-6 mb-3"><label class="form-label text-muted small">E-posta (Yayınlanmaz)</label>{{ yorum_form.email }}</div>
                            </div>
                            <div class="mb-3"><label class="form-label text-muted small">Yorumunuz</label>{{ yorum_form.govde }}</div>
                            <button type="submit" class="btn btn-success w-100 py-2 fw-bold"><i class="fas fa-paper-plane me-2"></i>GÖNDER</button>
                        </form>
                    </div>
                </div>
            </div>

            {% if benzer_haberler %}
            <div class="mb-5">
                <h4 class="border-bottom pb-2 mb-4 fw-bold" style="color: var(--ahsap-koyu);">Bunlar da İlginizi Çekebilir</h4>
                <div class="row">
                    {% for benzer in benzer_haberler %}
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-0 shadow-sm">
                            {% if benzer.resim %}
                                <img src="{{ benzer.resim.url }}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="{{ benzer.baslik }}">
                            {% else %}
                                <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 150px;">Resim Yok</div>
                            {% endif %}
                            <div class="card-body p-3">
                                <h6 class="card-title fw-bold mb-0" style="font-size: 0.9rem;">
                                    <a href="{% url 'haber_detay' benzer.pk %}" class="text-decoration-none text-dark stretched-link">{{ benzer.baslik|truncatechars:50 }}</a>
                                </h6>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="sticky-top" style="top: 20px; z-index: 1;">
                <div class="mb-4 text-center">
                    <div style="background-color: #f8f9fa; height: 250px; border: 1px dashed #999; display: flex; align-items: center; justify-content: center;">
                        <div><h5 class="text-muted">REKLAM</h5><small>300x250</small><br><a href="{% url 'iletisim' %}" class="text-primary small">Reklam Ver</a></div>
                    </div>
                </div>
                <div class="mb-4 text-center">
                    <div style="background-color: #f8f9fa; height: 600px; border: 1px dashed #999; display: flex; align-items: center; justify-content: center;">
                        <div><h5 class="text-muted">REKLAM</h5><small>300x600 (Skyscraper)</small><br><a href="{% url 'iletisim' %}" class="text-primary small">Reklam Ver</a></div>
                    </div>
                </div>
                <div class="mb-4 text-center">
                    <div style="background-color: #f8f9fa; height: 250px; border: 1px dashed #999; display: flex; align-items: center; justify-content: center;">
                        <div><h5 class="text-muted">REKLAM</h5><small>300x250</small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var images = document.querySelectorAll('.haber-icerik img');
        images.forEach(function(img) {
            img.removeAttribute('width'); img.removeAttribute('height');
            img.style.width = ''; img.style.height = ''; 
            img.classList.add('img-fluid'); 
        });
        window.copyLink = function() { navigator.clipboard.writeText(window.location.href); alert("Bağlantı kopyalandı!"); }
    });
</script>
{% endblock %}